name: Deploy to EC2 (Spring + FastAPI)

on:
  push:
    branches: [ "main" ]

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  # ì´ë¯¸ì§€ ì´ë¦„ (ì›í•˜ëŠ” ëŒ€ë¡œ ìˆ˜ì • ê°€ëŠ¥)
  SPRING_IMAGE_NAME: classmap-spring
  AI_IMAGE_NAME: classmap-ai

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ---------------------------------------------------
      # 1. Spring Boot ë¹Œë“œ ë° ì´ë¯¸ì§€ í‘¸ì‹œ
      # ---------------------------------------------------
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Build Spring Boot with Gradle
        run: ./gradlew clean bootJar -x test

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Spring Boot Image
        uses: docker/build-push-action@v5
        with:
          # [ì¤‘ìš”] build.gradleì´ ë£¨íŠ¸ì— ìˆìœ¼ë¯€ë¡œ contextëŠ” ì (.) ì…ë‹ˆë‹¤.
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/${{ env.SPRING_IMAGE_NAME }}:latest

      # ---------------------------------------------------
      # 2. AI Server (FastAPI) ì´ë¯¸ì§€ í‘¸ì‹œ
      # ---------------------------------------------------
      - name: Build and Push AI Server Image
        uses: docker/build-push-action@v5
        with:
          # [ì¤‘ìš”] ai-server í´ë”ë¥¼ ë£¨íŠ¸ì— ë³µì‚¬í•´ ë„£ì—ˆë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
          context: ./ai-server
          file: ./ai-server/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/${{ env.AI_IMAGE_NAME }}:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸš€ ë°°í¬ ì‹œì‘..."
            
            # 1. Docker Hub ë¡œê·¸ì¸
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

            # 2. ì‘ì—… í´ë” ìƒì„± ë° ì´ë™
            cd /home/ubuntu/my-project || mkdir -p /home/ubuntu/my-project && cd /home/ubuntu/my-project
            
            # 3. docker-compose.yml íŒŒì¼ ìƒì„± (ë®ì–´ì“°ê¸°)
            cat <<EOF > docker-compose.yml
            version: '3.8'
            services:
              spring-boot:
                image: ${{ secrets.DOCKER_USERNAME }}/${{ env.SPRING_IMAGE_NAME }}:latest
                ports:
                  - "8080:8080"
                environment:
                  - SPRING_DATASOURCE_URL=jdbc:postgresql://${{ secrets.DB_HOST }}:5432/postgres
                  - SPRING_DATASOURCE_USERNAME=${{ secrets.DB_USERNAME }}
                  - SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PASSWORD }}
                  - AI_SERVER_URL=http://ai-server:8000
                  - OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
                depends_on:
                  - ai-server

              ai-server:
                image: ${{ secrets.DOCKER_USERNAME }}/${{ env.AI_IMAGE_NAME }}:latest
                environment:
                  - OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            EOF

            # 4. ìµœì‹  ì´ë¯¸ì§€ Pull ë° ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
            docker compose pull
            docker compose up -d
            docker image prune -f
            
            echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"